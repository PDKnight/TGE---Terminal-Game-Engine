Function.prototype.bind=function(){}.bind||function(e){function t(){}if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var n=[].slice,r=n.call(arguments,1),i=this,o=function(){return i.apply(this instanceof t?this:e||window,r.concat(n.call(arguments)))};return t.prototype=this.prototype,o.prototype=new t,o};var TGE=function(e,t,n){this.version="1.0.0",this.cmds={history:[],count:0,current:0};var r=function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e["on"+t]=n},i=function(e,t){return t?document.querySelectorAll(e):document.querySelector(e)},o=function(e,t){terminal.innerHTML+="<div>"+("cmd"==t?TGE.path.get():"")+("cmd"==t?this.config.game.terminal:"")+("cmd"==t?e.replaceHTMLCharacters():e.replaceHTMLCharacters().replaceChatColors()).nl2br().trim()+"</div>",document.body.scrollTop=document.body.scrollHeight}.bind(this),s=function(){var e,t=Object.keys(this.commands);for(o("\n----- Commands ------------------------------"),o(" ?,help - Shows this help."),e=0;e<t.length;e++)this.commands[t[e]].hasOwnProperty("description")&&o(" "+t[e]+" - "+this.commands[t[e]].description)}.bind(this),a=function(e){var t,n=e[0],r=e[1];if(0!=n.length)return"github"==n?(t=window.open("https://github.com/PDKnight/","_blank"),t.focus()):(0==Object.keys(this.commands).length&&o('[Warning] There are no commands set in engine! Type "github" to open TGE github page.'),this.commands.hasOwnProperty(n)&&(this.commands[n].hasOwnProperty("description")||o("[Warning] The command has no description set yet!"),this.commands[n].hasOwnProperty("exec")||o("[Warning] The command has no exec function set yet!"))),"?"==n||"help"==n?void s():void(this.commands.hasOwnProperty(n)?this.commands[n].hasOwnProperty("exec")?this.commands[n].exec(r):this.log('&c[Error] The command "'+n+'" has no exec function set yet.'):this.log('&c[Error] Unknown command "'+n+'".'))}.bind(this),c=function(e){var t,n;return t=n="",e=e.replace(/\s+/," ").split(" "),t=e[0],e.shift(),n=e,[t,n]},h=function(){String.prototype.trim=function(){return this.replace(/^\s*|\s*$/g,"")},String.prototype.replaceHTMLCharacters=function(){return this.replace(/<|>|&| /g,function(e){return{"<":"&lt;",">":"&gt;","&":"&amp;"," ":"&nbsp;"}[e]})},String.prototype.nl2br=function(){return this.replace(/\r|\n/g,"<br>")},String.prototype.replaceChatColors=function(){window;return this.replace(/&amp;(r|[0-9a-f])/g,function(e){return'<font color="#'+{0:"000",1:"00A",2:"0A0",3:"0AA",4:"A00",5:"A0A",6:"FA0",7:"AAA",8:"555",9:"55F",a:"5F5",b:"5FF",c:"F55",d:"F5F",e:"FF5",f:"FFF",r:t.game.textColor.slice(1)}[e[e.length-1]]+'">'})};var e=i(this.environment);if(!e)throw new Error("Unknown element selector "+this.environment+". Please make sure you haven't make any mistake.");var n=function(t,n,r){var i=document.createElement(t);for(param in n)"inner"==param?i.innerHTML=n[param]:i[param]=n[param];r?r.appendChild(i):e.appendChild(i)};n("div",{id:"terminal"}),n("span",{id:"cmdline",inner:TGE.path.get()+this.config.game.terminal.replaceHTMLCharacters()}),n("div",{id:"cursor",className:"off"}),n("input",{id:"input",type:"text"});var s=i(this.environment+" #input");document.title=this.config.game.name,document.body.style.background=this.config.game.bgColor,document.body.style.color=this.config.game.textColor,document.body.style.overflow=this.config.game.scrollable?"":"hidden",o(this.config.welcome.replace(/%version%/g,this.version));var h=function(){s.focus(),setTimeout(function(){s.selectionStart=s.selectionEnd=1e5},0)};r(document,"keydown",h),r(document,"keyup",h),r(document,"click",h),r(s,"blur",h);var l=function(e){var t=s.value.trim(),n=e.keyCode||e.which;if(13==n&&t.length>0){s.value="",o(t,"cmd");var r=c(t);a(r),this.cmds.history.push(t),this.cmds.count++,this.cmds.current=this.cmds.count}if("keydown"==e.type)switch(n){case 38:this.cmds.current>0&&(this.cmds.current--,s.value=this.cmds.history[this.cmds.current]);break;case 40:this.cmds.current<this.cmds.count-1?(this.cmds.current++,s.value=this.cmds.history[this.cmds.current-1]):(s.value="",this.cmds.current==this.cmds.count-1&&this.cmds.current++)}8==n&&0==s.value.length&&(e.preventDefault?e.preventDefault():e.returnValue=!1,s.focus()),i(this.environment+" #cmdline").innerHTML=TGE.path.get()+this.config.game.terminal.replaceHTMLCharacters()+s.value.replaceHTMLCharacters()}.bind(this);r(s,"keydown",l),r(s,"keyup",l),XXHR().request(this.config.map+"?dir=home",function(e){var t=JSON.parse(e),n=t.type,r=t.data,i=(r.dirs,r.message);switch(n){case"map":r.hasOwnProperty("text")&&r.text.length>0&&TGE.getInstance().log(r.text.join("\n")+"\n");break;case"error":default:TGE.getInstance().log("&c[Error] "+("error"==n?i:"Unknown error type: "+n))}},function(e){TGE.getInstance().log("&c[Error] An error happened with AJAX request. Message: "+e)}),setInterval(function(){var e="on"==(cursor.className||"off")?"off":"on";cursor.className=e},600)}.bind(this);this.environment=e,this.config=t,this.commands=n,this.log=o,this.sel=i,h()};TGE.getInstance=function(){return window[TGE.instanceName]},TGE.getInstanceName=function(){return TGE.instanceName},TGE.path={pathPrefix:"C:/",path:"",get:function(){return this.pathPrefix+this.path},set:function(e){this.path=e},cd:function(e,t,n){var r=e.split("/"),t=t||(r.length>0?r:t);if(t.length>1&&"number"!=typeof n)this.cd(t[0],t,0);else if(e.length>0)if(".."==e){var i=this.path.split("/");i.pop(),this.path=i.join("/");var o=TGE.getInstance().config.map;if(!o)return void TGE.getInstance().log("[Warning] There is no map set in config file!");var s=this.path;"/"==s[0]&&(s=s.slice(1)),XXHR().request(o+"?dir="+(s||"Home"),function(e){var r=JSON.parse(e),i=r.type,o=r.data,s=(o?o.dirs:[],o?o.message:[]);switch(i){case"map":o.hasOwnProperty("text")&&o.text.length>0&&TGE.getInstance().log(o.text.join("\n")+"\n");break;case"error":default:TGE.getInstance().log("&c[Error] "+("error"==i?s:"Unknown error type: "+i))}n<t.length-1&&this.cd(t[n+1],t,n+1)}.bind(this),function(e){TGE.getInstance().log("&c[Error] An error happened with AJAX request. Message: "+e)})}else{var o=TGE.getInstance().config.map;if(!o)return void TGE.getInstance().log("[Warning] There is no map set in config file!");var s=this.path+"/"+e;"/"==s[0]&&(s=s.slice(1)),XXHR().request(o+"?dir="+(s||"Home"),function(r){var i=JSON.parse(r),o=i.type,s=i.data,a=s?s.dirs:[],c=s?s.message:[];switch(o){case"map":if(a.length>0){s.hasOwnProperty("text")&&s.text.length>0&&TGE.getInstance().log(s.text.join("\n")+"\n"),this.path+=(this.path.indexOf("/")==this.path.length-1?"":"/")+e;var h=TGE.getInstance();h.sel(h.environment+" #cmdline").innerHTML=TGE.path.get()+h.config.game.terminal.replaceHTMLCharacters()+h.sel(h.environment+" #input").value.replaceHTMLCharacters()}break;case"error":default:TGE.getInstance().log("&c[Error] "+("error"==o?c:"Unknown error type: "+o))}n<t.length-1&&this.cd(t[n+1],t,n+1)}.bind(this),function(e){TGE.getInstance().log("&c[Error] An error happened with AJAX request. Message: "+e)})}}};