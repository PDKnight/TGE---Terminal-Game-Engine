// Web Console Engine by PDKnight. (c) 2016.
// You can find more at https://github.com/PDKnight/WCE-Web-Console-Engine
Function.prototype.bind=function(){}.bind||function(t){function n(){}if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var e=[].slice,i=e.call(arguments,1),r=this,s=function(){return r.apply(this instanceof n?this:t||window,i.concat(e.call(arguments)))};return n.prototype=this.prototype,s.prototype=new n,s};var WCE=function(t,n,e){this.version="2.0",this.cmds={history:[],count:0,current:0};var i=function(t,n,e){t.addEventListener?t.addEventListener(n,e,!1):t.attachEvent?t.attachEvent("on"+n,e):t["on"+n]=e},r=function(t,n){return n?document.querySelectorAll(t):document.querySelector(t)},s=function(t,n){terminal.innerHTML+="<div>"+("cmd"==n&&WCE.path?WCE.path.get():"")+("cmd"==n?this.config.look.terminal:"")+("cmd"==n?t.replaceHTMLCharacters():t.replaceHTMLCharacters().replaceChatColors()).nl2br().trim()+"</div>";var e=r(this.environment);e.scrollTop=e.scrollHeight}.bind(this),o=function(){var t,n=Object.keys(this.commands);for(s("\n----- Commands ------------------------------"),s(" ?,help - Shows this help."),t=0;t<n.length;t++)this.commands[n[t]].hasOwnProperty("description")&&s(" "+n[t]+" - "+this.commands[n[t]].description)}.bind(this),c=function(t){var n,e=t[0],i=t[1];if(0!=e.length)return"github"==e?(n=window.open("https://github.com/PDKnight/","_blank"),n.focus()):(0==Object.keys(this.commands).length&&s('[Warning] There are no commands set in engine! Type "github" to open WCE github page.'),this.commands.hasOwnProperty(e)&&(this.commands[e].hasOwnProperty("description")||s("[Warning] The command has no description set yet!"),this.commands[e].hasOwnProperty("exec")||s("[Warning] The command has no exec function set yet!"))),"?"==e||"help"==e?void o():void(this.commands.hasOwnProperty(e)?this.commands[e].hasOwnProperty("exec")?this.commands[e].exec(i):this.log('&c[Error] The command "'+e+'" has no exec function set yet.'):"github"!=e&&this.log('&c[Error] Unknown command "'+e+'".'))}.bind(this),a=function(t){var n,e;return n=e="",t=t.replace(/\s+/," ").split(" "),n=t[0],t.shift(),e=t,[n,e]};this.init=function(){String.prototype.trim=function(){return this.replace(/^\s*|\s*$/g,"")},String.prototype.replaceHTMLCharacters=function(){return this.replace(/<|>|&| /g,function(t){return{"<":"&lt;",">":"&gt;","&":"&amp;"," ":"&nbsp;"}[t]})},String.prototype.nl2br=function(){return this.replace(/\r|\n/g,"<br>")},String.prototype.replaceChatColors=function(){window;return this.replace(/&amp;(r|[0-9a-f])/g,function(t){return'<font color="#'+{0:"000",1:"00A",2:"0A0",3:"0AA",4:"A00",5:"A0A",6:"FA0",7:"AAA",8:"555",9:"55F",a:"5F5",b:"5FF",c:"F55",d:"F5F",e:"FF5",f:"FFF",r:n.look.textColor.slice(1)}[t[t.length-1]]+'">'})};var t=r(this.environment);if(!t)throw new Error("Unknown element selector "+this.environment+". Please make sure you haven't make any mistake.");var e=function(n,e,i){var r=document.createElement(n);for(param in e)"inner"==param?r.innerHTML=e[param]:r[param]=e[param];i?i.appendChild(r):t.appendChild(r)};t.className+=(t.className.length?" ":"")+"wceevn_"+(WCE.instances.length-1),t.style.background=this.config.look.bgColor,t.style.color=this.config.look.textColor,t.style.overflowY=this.config.look.scrollable?"scroll":"hidden",e("div",{id:"terminal"}),e("span",{id:"cmdline",inner:this.config.look.terminal.replaceHTMLCharacters()}),e("div",{id:"cursor",className:"off"}),e("input",{id:"input",type:"text",className:"wceinput"});var o=r(this.environment+"."+t.className+" #input");document.title=this.config.look.name,s(this.config.welcome.replace(/%version%/g,this.version));var h=function(){o.focus(),setTimeout(function(){o.selectionStart=o.selectionEnd=1e5},0)};i(t,"click",h);var l=function(t){var n=o.value.trim(),e=t.keyCode||t.which;if(13==e&&n.length>0){o.value="",s(n,"cmd");var i=a(n);c(i),this.cmds.history.push(n),this.cmds.count++,this.cmds.current=this.cmds.count}if("keydown"==t.type)switch(e){case 38:this.cmds.current>0&&(this.cmds.current--,o.value=this.cmds.history[this.cmds.current]);break;case 40:this.cmds.current<this.cmds.count-1?(this.cmds.current++,o.value=this.cmds.history[this.cmds.current-1]):(o.value="",this.cmds.current==this.cmds.count-1&&this.cmds.current++)}if(8==e&&0==o.value.length&&(t.preventDefault?t.preventDefault():t.returnValue=!1,o.focus()),r(this.environment+" #cmdline").innerHTML=this.config.look.terminal.replaceHTMLCharacters()+o.value.replaceHTMLCharacters(),WCE.keydownListeners.length>0)for(var h=0;h<WCE.keydownListeners.length;h++)WCE.keydownListeners[h](t)}.bind(this);if(i(o,"keydown",l),i(o,"keyup",l),setInterval(function(){if(-1==document.activeElement.className.split(" ").indexOf("wceinput"))return void(cursor.className="off");var t="on"==(cursor.className||"off")?"off":"on";cursor.className=t},600),WCE.initListeners.length>0)for(var u=0;u<WCE.initListeners.length;u++)WCE.initListeners[u]()}.bind(this),this.environment=t,this.config=n,this.commands=e,this.log=s,this.sel=r,this.items=[],this.getUrlPath=function(){return"?dir="+(WCE.path.path||"home")+"&items="+this.items.join(",")}.bind(this),this.getUrlItems=function(){return"&items="+this.items.join(",")}.bind(this)};WCE.initListeners=[],WCE.keydownListeners=[],WCE.instances=[],WCE.createInstance=function(t,n,e){if(3!=arguments.length)throw new Error("WCE.createInstance() needs 3 arguments, "+arguments.length+" represented.");WCE.instances.push(new WCE(t,n,e))},WCE.addInitListener=function(t){WCE.initListeners.push(t)},WCE.addKeydownListener=function(t){WCE.keydownListeners.push(t)},WCE.getInstance=function(t){var n=WCE.instances;return n instanceof Array&&0!=n.length?n[t||0]:{}},WCE.getInstances=function(){return WCE.instances};